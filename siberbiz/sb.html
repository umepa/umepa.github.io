<script>
const messages = document.getElementById('messages');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');

// === BURAYA KENDİ API ANAHTARINI YAPIŞTIR (Bearer ile birlikte) ===
const apiKey = "Bearer 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";

function addMessage(text, sender) {
  const div = document.createElement('div');
  div.classList.add('message', sender);
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function addImage(url) {
  const img = document.createElement('img');
  img.src = url;
  img.classList.add('generated');
  messages.appendChild(img);
  messages.scrollTop = messages.scrollHeight;
}

async function generateImage(prompt) {
  const res = await fetch("https://api.openai.com/v1/images/generations", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": apiKey
    },
    body: JSON.stringify({
      model: "dall-e-3",
      prompt: prompt,
      n: 1,
      size: "512x512"
    })
  });
  const data = await res.json();
  if (!data.data || !data.data[0] || !data.data[0].url) {
    console.error("Görsel API yanıtı:", data);
    throw new Error("Görsel oluşturulamadı.");
  }
  return data.data[0].url;
}

async function sendToOpenAI(prompt) {
  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": apiKey
    },
    body: JSON.stringify({
      model: "gpt-4o",
      messages: [{role: "user", content: prompt}]
    })
  });
  const data = await response.json();
  if (!data.choices || !data.choices[0] || !data.choices[0].message) {
    console.error("OpenAI yanıtı:", data);
    throw new Error("API'den geçerli yanıt alınamadı.");
  }
  return data.choices[0].message.content;
}

sendBtn.addEventListener('click', async () => {
  const text = userInput.value.trim();
  if (!text) return;
  addMessage(text, "user");
  userInput.value = "";

  const loading = document.createElement("div");
  loading.classList.add("message", "bot");
  loading.textContent = "Yükleniyor...";
  messages.appendChild(loading);

  try {
    if (text.toLowerCase().includes("resim") || text.toLowerCase().includes("çiz")) {
      const imageURL = await generateImage(text);
      messages.removeChild(loading);
      addMessage("İşte oluşturduğum görsel:", "bot");
      addImage(imageURL);
    } else {
      const reply = await sendToOpenAI(text);
      messages.removeChild(loading);
      addMessage(reply, "bot");
    }
  } catch (e) {
    messages.removeChild(loading);
    addMessage("Hata oluştu: " + e.message, "bot");
  }
});

userInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendBtn.click();
});
</script>
